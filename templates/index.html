<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis S-Box AES (Replikasi Paper)</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome untuk Ikon -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-slate-50 font-inter text-slate-800" data-candidates='{{ candidates | tojson | safe }}'>

    <!-- Navbar -->
    <nav class="bg-indigo-900 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <i class="fas fa-shield-alt text-2xl text-yellow-400"></i>
                    <div>
                        <h1 class="font-bold text-lg leading-tight">AES S-Box Explorer</h1>
                        <p class="text-[10px] text-indigo-300">Replikasi Paper Alamsyah et al.</p>
                    </div>
                </div>
                <!-- Selector Dropdown -->
                <div class="flex items-center gap-2">
                    <label class="text-xs text-indigo-200 hidden sm:block">Pilih Matriks Affine:</label>
                    <select id="matrixSelector" class="bg-indigo-800 text-white text-sm border border-indigo-600 rounded px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                        <!-- Options akan diisi oleh JavaScript -->
                    </select>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Info Card -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <!-- Kartu Info Matriks -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 col-span-2">
                <h2 id="matrixName" class="text-2xl font-bold text-indigo-900 mb-1">AES Standard</h2>
                <span id="matrixType" class="inline-block px-2 py-1 text-xs font-semibold rounded bg-slate-100 text-slate-500">Standard Reference</span>
                <p class="mt-4 text-slate-600 text-sm">
                    Matriks ini digunakan untuk mentransformasi invers di GF(2^8) menjadi S-box.
                    Perubahan pada matriks ini akan mengubah seluruh struktur S-box dan nilai kekuatannya (SAC).
                </p>
            </div>

            <!-- Kartu Metrik SAC -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-center items-center text-center relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <i class="fas fa-chart-line text-6xl text-indigo-900"></i>
                </div>
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-2">SAC Value</h3>
                <div id="sacValue" class="text-4xl font-mono font-bold text-slate-800">0.50488</div>
                <div id="sacVerdict" class="mt-2 text-xs font-medium px-2 py-1 rounded bg-slate-100 text-slate-500">
                    Target: 0.5
                </div>
            </div>
        </div>

        <div class="grid lg:grid-cols-12 gap-8">
            
            <!-- Kolom Kiri: Visualisasi Matriks (4 Kolom) -->
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                        <i class="fas fa-th text-indigo-500"></i> Affine Matrix (8x8)
                    </h3>
                    <div id="matrixGrid" class="grid grid-cols-8 gap-1 w-fit mx-auto">
                        <!-- Grid generated by JS -->
                    </div>
                    <p class="text-xs text-center text-slate-400 mt-3 font-mono">Bit 1 (Blue) / Bit 0 (Gray)</p>
                </div>

                <!-- Encryption Playground -->
                <div class="bg-indigo-50 p-5 rounded-xl border border-indigo-100">
                    <h3 class="font-bold text-indigo-900 mb-3 flex items-center gap-2">
                        <i class="fas fa-lock"></i> Uji Coba Enkripsi
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-semibold text-indigo-700">Input Teks</label>
                            <input type="text" id="inputPlain" placeholder="Ketik sesuatu..." class="w-full p-2 text-sm border border-indigo-200 rounded focus:outline-none focus:border-indigo-500 font-mono">
                        </div>
                        <div class="text-center">
                            <i class="fas fa-arrow-down text-indigo-300"></i>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-indigo-700">Output Hex (SubBytes)</label>
                            <div id="outputCipher" class="w-full p-2 text-sm bg-white border border-indigo-200 rounded font-mono text-indigo-600 break-all min-h-[40px]">
                                ...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kolom Kanan: Visualisasi S-Box (8 Kolom) -->
            <div class="lg:col-span-8">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700 flex items-center gap-2">
                            <i class="fas fa-table text-indigo-500"></i> Generated S-Box Table
                        </h3>
                        <div class="text-xs text-slate-400">Hover cell untuk detail</div>
                    </div>
                    
                    <div id="sboxGrid" class="grid grid-cols-16 gap-[1px] bg-slate-200 border border-slate-200">
                        <!-- Sbox Grid generated by JS -->
                    </div>
                    
                    <div id="hoverInfo" class="mt-4 h-6 text-sm font-mono text-center text-slate-600 font-medium">
                        Arahkan kursor ke tabel...
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Data Passing from Flask to JS (read from body data attribute to avoid Jinja delimiters inside JS) -->
    <script>
        // Mengambil data JSON yang dikirim dari Flask (app.py) dari atribut data pada body
        const candidatesData = JSON.parse(document.body.getAttribute('data-candidates') || '[]');
    </script>

    <!-- Main Logic Script -->
    <script>
        // DOM Elements
        const selector = document.getElementById('matrixSelector');
        const elName = document.getElementById('matrixName');
        const elType = document.getElementById('matrixType');
        const elSac = document.getElementById('sacValue');
        const elVerdict = document.getElementById('sacVerdict');
        const elMatrixGrid = document.getElementById('matrixGrid');
        const elSboxGrid = document.getElementById('sboxGrid');
        const elInputPlain = document.getElementById('inputPlain');
        const elOutputCipher = document.getElementById('outputCipher');
        const elHoverInfo = document.getElementById('hoverInfo');

        // State Global
        let currentCandidate = candidatesData[0]; // Default AES

        // 1. Inisialisasi Dropdown
        function initDropdown() {
            // Group 1: References
            const groupRef = document.createElement('optgroup');
            groupRef.label = "Referensi Utama";
            
            // Group 2: Generated
            const groupGen = document.createElement('optgroup');
            groupGen.label = "Hasil Eksplorasi (Random)";

            candidatesData.forEach((item, index) => {
                const opt = document.createElement('option');
                opt.value = index; // Kita pakai index array sebagai value
                opt.textContent = item.name;
                
                if (item.type === 'standard' || item.type === 'proposed') {
                    groupRef.appendChild(opt);
                } else {
                    groupGen.appendChild(opt);
                }
            });

            selector.appendChild(groupRef);
            selector.appendChild(groupGen);

            // Set default K44 jika ada (biasanya index 1)
            const k44Index = candidatesData.findIndex(c => c.id === 'K_44');
            if(k44Index !== -1) selector.value = k44Index;
        }

        // 2. Fungsi Render Matriks 8x8
        function renderMatrix(matrix) {
            elMatrixGrid.innerHTML = '';
            matrix.forEach(row => {
                row.forEach(bit => {
                    const div = document.createElement('div');
                    div.className = `w-6 h-6 sm:w-8 sm:h-8 flex items-center justify-center text-xs font-mono rounded transition-all duration-300 ${bit ? 'bg-indigo-600 text-white shadow-sm scale-95' : 'bg-slate-100 text-slate-300'}`;
                    div.textContent = bit;
                    elMatrixGrid.appendChild(div);
                });
            });
        }

        // 3. Fungsi Render S-Box Table
        function renderSbox(sbox) {
            elSboxGrid.innerHTML = '';
            sbox.forEach((val, idx) => {
                const hexVal = val.toString(16).toUpperCase().padStart(2, '0');
                const hexIdx = idx.toString(16).toUpperCase().padStart(2, '0');
                
                const div = document.createElement('div');
                div.className = "aspect-square flex items-center justify-center text-[10px] sm:text-xs font-mono bg-white text-slate-600 hover:bg-yellow-300 hover:text-yellow-900 hover:scale-125 hover:z-10 hover:shadow-lg transition-transform cursor-default";
                div.textContent = hexVal;
                
                // Event Hover
                div.addEventListener('mouseenter', () => {
                    elHoverInfo.innerHTML = `Input: <span class="font-bold text-indigo-600">0x${hexIdx} (${idx})</span> &rarr; Output: <span class="font-bold text-indigo-600">0x${hexVal} (${val})</span>`;
                });

                elSboxGrid.appendChild(div);
            });
        }

        // 4. Fungsi Update UI Utama
        function updateUI(index) {
            currentCandidate = candidatesData[index];

            // Update Info Header
            elName.textContent = currentCandidate.name;
            
            // Update Type Badge
            let badgeClass = "bg-slate-100 text-slate-500";
            if(currentCandidate.type === 'proposed') badgeClass = "bg-emerald-100 text-emerald-700 border border-emerald-200";
            if(currentCandidate.type === 'generated') badgeClass = "bg-blue-50 text-blue-600";
            
            elType.className = `inline-block px-3 py-1 text-xs font-bold rounded-full ${badgeClass}`;
            elType.textContent = currentCandidate.id;

            // Update Metrics (SAC)
            elSac.textContent = currentCandidate.sac.toFixed(5);
            
            // Logic Verdict
            const diff = Math.abs(0.5 - currentCandidate.sac);
            const aesDiff = Math.abs(0.5 - 0.50488); // Hardcoded AES ref
            
            if (diff < aesDiff) {
                elVerdict.innerHTML = `<span class="text-emerald-600"><i class="fas fa-check-circle"></i> Lebih baik dari AES Standard</span>`;
                elSac.className = "text-4xl font-mono font-bold text-emerald-600";
            } else if (currentCandidate.id === 'AES_STD') {
                elVerdict.textContent = "Standard Reference";
                elSac.className = "text-4xl font-mono font-bold text-slate-800";
            } else {
                elVerdict.innerHTML = `<span class="text-slate-500">Kurang optimal dibanding AES</span>`;
                elSac.className = "text-4xl font-mono font-bold text-slate-500";
            }

            // Render Grids
            renderMatrix(currentCandidate.matrix);
            renderSbox(currentCandidate.sbox);
            
            // Trigger Re-encrypt
            doEncryption();
        }

        // 5. Fungsi Enkripsi Sederhana
        function doEncryption() {
            const text = elInputPlain.value;
            if(!text) {
                elOutputCipher.textContent = "...";
                return;
            }

            const cipherHex = text.split('').map(char => {
                const code = char.charCodeAt(0);
                // SubBytes logic: ambil nilai dari S-box berdasarkan index ASCII/Unicode
                const sub = currentCandidate.sbox[code % 256]; 
                return sub.toString(16).toUpperCase().padStart(2, '0');
            }).join(' ');

            elOutputCipher.textContent = cipherHex;
        }

        // --- Event Listeners ---
        
        // Saat Dropdown berubah
        selector.addEventListener('change', (e) => {
            updateUI(e.target.value);
        });

        // Saat Input Teks berubah
        elInputPlain.addEventListener('input', doEncryption);

        // Init
        initDropdown();
        updateUI(selector.value); // Load initial selection

    </script>
</body>
</html>
