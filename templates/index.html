<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis S-Box AES (Replikasi Paper)</title>
    
    <!-- 1. Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. KONFIGURASI TAMBAHAN (GRID 17) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    gridTemplateColumns: {
                        '17': '30px repeat(16, minmax(0, 1fr))', 
                    }
                }
            }
        }
    </script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <style>
        #floatingTooltip {
            pointer-events: none;
            transition: opacity 0.05s ease;
            white-space: nowrap; /* Mencegah teks turun baris */
        }
    </style>
</head>

<body class="bg-slate-50 font-inter text-slate-800" data-candidates='{{ candidates | tojson | safe }}'>

    <!-- TOOLTIP ELEMENT -->
    <div id="floatingTooltip" class="fixed hidden z-[9999] bg-slate-900/95 backdrop-blur-sm text-white px-3 py-2 rounded shadow-2xl text-xs font-mono border border-slate-600 opacity-0 transform -translate-x-1/2 -translate-y-[120%]">
        <!-- Content JS -->
    </div>

    <!-- Navbar -->
    <nav class="bg-indigo-900 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <i class="fas fa-shield-alt text-2xl text-yellow-400"></i>
                    <div>
                        <h1 class="font-bold text-lg leading-tight">AES S-Box Explorer</h1>
                        <p class="text-[10px] text-indigo-300">Replikasi Paper Pak Alamsyah et al.</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-xs text-indigo-200 hidden sm:block">Pilih Matriks Affine:</label>
                    <select id="matrixSelector" class="bg-indigo-800 text-white text-sm border border-indigo-600 rounded px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-yellow-400 cursor-pointer">
                        <!-- Options diisi JS -->
                    </select>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Info Card -->
        <div class="grid md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 col-span-2">
                <h2 id="matrixName" class="text-xl font-bold text-indigo-900 mb-1">AES Standard</h2>
                <span id="matrixType" class="inline-block px-2 py-0.5 text-[10px] font-semibold rounded bg-slate-100 text-slate-500">Standard Reference</span>
                <p class="mt-3 text-slate-600 text-xs sm:text-sm">
                    Matriks ini digunakan untuk mentransformasi invers di GF(2^8) menjadi S-box.
                    Perubahan pada matriks ini akan mengubah seluruh struktur S-box dan nilai kekuatannya (SAC).
                </p>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-center items-center text-center relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <i class="fas fa-chart-line text-6xl text-indigo-900"></i>
                </div>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">SAC Value</h3>
                <div id="sacValue" class="text-3xl font-mono font-bold text-slate-800">0.50488</div>
                <div id="sacVerdict" class="mt-2 text-[10px] font-medium px-2 py-1 rounded bg-slate-100 text-slate-500">
                    Target: 0.5
                </div>
            </div>
        </div>

        <div class="grid lg:grid-cols-12 gap-6">
            
            <!-- Kolom Kiri: Matriks & Enkripsi -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Visualisasi Matriks Affine -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-sm text-slate-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-th text-indigo-500"></i> Affine Matrix (8x8)
                    </h3>
                    <div id="matrixGrid" class="grid grid-cols-8 gap-1 w-fit mx-auto">
                        <!-- Grid generated by JS -->
                    </div>
                    <p class="text-[10px] text-center text-slate-400 mt-2 font-mono">Bit 1 (Blue) / Bit 0 (Gray)</p>
                </div>

                <!-- Panel Enkripsi & Dekripsi -->
                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                    <h3 class="font-bold text-sm text-indigo-900 mb-3 flex items-center gap-2">
                        <i class="fas fa-lock"></i> Uji Coba Enkripsi & Dekripsi
                    </h3>
                    <div class="space-y-3">
                        <!-- Input -->
                        <div>
                            <label class="text-[10px] uppercase font-bold text-indigo-400 tracking-wider">1. Input Plaintext</label>
                            <input type="text" id="inputPlain" placeholder="Ketik sesuatu..." class="w-full p-2 text-sm border border-indigo-200 rounded focus:outline-none focus:border-indigo-500 font-mono shadow-sm mt-1">
                        </div>
                        
                        <!-- Ciphertext -->
                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <label class="text-[10px] uppercase font-bold text-indigo-400 tracking-wider">2. Ciphertext (Hex)</label>
                                <span class="text-[10px] text-indigo-300"><i class="fas fa-arrow-down"></i> Encrypt</span>
                            </div>
                            <div id="outputCipher" class="w-full p-2 text-sm bg-white border border-indigo-200 rounded font-mono text-indigo-600 break-all min-h-[36px] shadow-sm">...</div>
                        </div>

                        <!-- Decrypted -->
                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <label class="text-[10px] uppercase font-bold text-emerald-600 tracking-wider">3. Recovered Text</label>
                                <span class="text-[10px] text-emerald-400"><i class="fas fa-arrow-down"></i> Decrypt</span>
                            </div>
                            <div id="outputDecrypted" class="w-full p-2 text-sm bg-emerald-50 border border-emerald-200 rounded font-mono text-emerald-800 break-all min-h-[36px] shadow-sm">...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kolom Kanan: S-Box Table -->
            <div class="lg:col-span-8">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-sm text-slate-700 flex items-center gap-2">
                            <i class="fas fa-table text-indigo-500"></i> Generated S-Box Table
                        </h3>
                        <div class="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded border border-yellow-200">
                            <i class="fas fa-mouse-pointer mr-1"></i>Hover cell untuk detail
                        </div>
                    </div>
                    
                    <!-- SBOX GRID COMPACT -->
                    <div id="sboxGrid" class="grid grid-cols-17 gap-[1px] bg-slate-300 border border-slate-300 text-[10px] sm:text-[11px]">
                        <!-- Sbox Grid generated by JS -->
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Data -->
    <script>
        const candidatesData = JSON.parse(document.body.getAttribute('data-candidates') || '[]');
    </script>

    <!-- Main Logic -->
    <script>
        const selector = document.getElementById('matrixSelector');
        const elName = document.getElementById('matrixName');
        const elType = document.getElementById('matrixType');
        const elSac = document.getElementById('sacValue');
        const elVerdict = document.getElementById('sacVerdict');
        const elMatrixGrid = document.getElementById('matrixGrid');
        const elSboxGrid = document.getElementById('sboxGrid');
        
        const elInputPlain = document.getElementById('inputPlain');
        const elOutputCipher = document.getElementById('outputCipher');
        const elOutputDecrypted = document.getElementById('outputDecrypted');
        
        const tooltip = document.getElementById('floatingTooltip');

        let currentCandidate = candidatesData[0];
        let inverseSBox = [];

        function generateInverseSBox(sbox) {
            const inv = new Array(256);
            for(let i=0; i<256; i++) inv[sbox[i]] = i;
            return inv;
        }

        function initDropdown() {
            const groupRef = document.createElement('optgroup'); groupRef.label = "Referensi Utama";
            const groupGen = document.createElement('optgroup'); groupGen.label = "Hasil Eksplorasi (Random)";

            candidatesData.forEach((item, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.textContent = item.name;
                if (item.type === 'standard' || item.type === 'proposed') groupRef.appendChild(opt);
                else groupGen.appendChild(opt);
            });
            selector.appendChild(groupRef);
            selector.appendChild(groupGen);
            
            const k44Index = candidatesData.findIndex(c => c.id === 'K_44');
            if(k44Index !== -1) selector.value = k44Index;
        }

        function renderMatrix(matrix) {
            elMatrixGrid.innerHTML = '';
            matrix.forEach(row => {
                row.forEach(bit => {
                    const div = document.createElement('div');
                    div.className = `w-6 h-6 sm:w-8 sm:h-8 flex items-center justify-center text-xs font-mono rounded transition-all duration-300 ${bit ? 'bg-indigo-600 text-white shadow-sm scale-95' : 'bg-slate-100 text-slate-300'}`;
                    div.textContent = bit;
                    elMatrixGrid.appendChild(div);
                });
            });
        }

        function renderSbox(sbox) {
            elSboxGrid.innerHTML = '';

            // 1. Header Row (0-F)
            const emptyCorner = document.createElement('div');
            emptyCorner.className = "bg-slate-200"; 
            elSboxGrid.appendChild(emptyCorner);

            for(let i=0; i<16; i++) {
                const head = document.createElement('div');
                head.className = "bg-slate-200 text-slate-500 font-bold flex items-center justify-center py-1";
                head.textContent = i.toString(16).toUpperCase();
                elSboxGrid.appendChild(head);
            }

            // 2. Data Rows
            for(let row=0; row<16; row++) {
                // Header Baris (0-F)
                const rowHead = document.createElement('div');
                rowHead.className = "bg-slate-200 text-slate-500 font-bold flex items-center justify-center";
                rowHead.textContent = row.toString(16).toUpperCase();
                elSboxGrid.appendChild(rowHead);

                // 16 Data Cells
                for(let col=0; col<16; col++) {
                    const idx = (row * 16) + col;
                    const val = sbox[idx];
                    const hexVal = val.toString(16).toUpperCase().padStart(2, '0');
                    const hexIdx = idx.toString(16).toUpperCase().padStart(2, '0');

                    const div = document.createElement('div');
                    // FIX TABLE SIZE: Mengganti aspect-square dengan h-8 (tinggi fix kecil)
                    div.className = "h-7 sm:h-8 flex items-center justify-center font-mono bg-white text-slate-600 hover:bg-yellow-300 hover:text-yellow-900 cursor-crosshair transition-colors";
                    div.textContent = hexVal;

                    // TOOLTIP FIX: Gunakan clientX/clientY (Viewport) bukan pageX/pageY (Document)
                    div.addEventListener('mouseenter', () => {
                        tooltip.innerHTML = `<span class="text-slate-400">Idx:</span> <span class="text-yellow-400 font-bold">0x${hexIdx}</span> <span class="text-slate-500 mx-1">â†’</span> <span class="text-slate-400">Val:</span> <span class="text-green-400 font-bold">0x${hexVal}</span>`;
                        tooltip.classList.remove('hidden');
                        requestAnimationFrame(() => tooltip.classList.remove('opacity-0'));
                    });

                    div.addEventListener('mouseleave', () => {
                        tooltip.classList.add('opacity-0');
                        tooltip.classList.add('hidden');
                    });

                    div.addEventListener('mousemove', (e) => {
                        // Posisi tooltip mengikuti viewport (client) karena tooltip fixed
                        tooltip.style.left = `${e.clientX}px`;
                        tooltip.style.top = `${e.clientY - 10}px`; 
                    });

                    elSboxGrid.appendChild(div);
                }
            }
        }

        function updateUI(index) {
            currentCandidate = candidatesData[index];
            inverseSBox = generateInverseSBox(currentCandidate.sbox);
            
            elName.textContent = currentCandidate.name;
            
            let badgeClass = "bg-slate-100 text-slate-500";
            if(currentCandidate.type === 'proposed') badgeClass = "bg-emerald-100 text-emerald-700 border border-emerald-200";
            if(currentCandidate.type === 'generated') badgeClass = "bg-blue-50 text-blue-600";
            
            elType.className = `inline-block px-3 py-1 text-xs font-bold rounded-full ${badgeClass}`;
            elType.textContent = currentCandidate.id;
            elSac.textContent = currentCandidate.sac.toFixed(5);
            
            const diff = Math.abs(0.5 - currentCandidate.sac);
            const aesDiff = Math.abs(0.5 - 0.50488);
            
            if (diff < aesDiff) {
                elVerdict.innerHTML = `<span class="text-emerald-600"><i class="fas fa-check-circle"></i> Lebih baik dari AES Standard</span>`;
                elSac.className = "text-3xl font-mono font-bold text-emerald-600";
            } else if (currentCandidate.id === 'AES_STD') {
                elVerdict.textContent = "Standard Reference";
                elSac.className = "text-3xl font-mono font-bold text-slate-800";
            } else {
                elVerdict.innerHTML = `<span class="text-slate-500">Kurang optimal dibanding AES</span>`;
                elSac.className = "text-3xl font-mono font-bold text-slate-500";
            }

            renderMatrix(currentCandidate.matrix);
            renderSbox(currentCandidate.sbox);
            doProcess();
        }

        function doProcess() {
            const text = elInputPlain.value;
            if(!text) { 
                elOutputCipher.textContent = "..."; 
                elOutputDecrypted.textContent = "...";
                return; 
            }

            const cipherBytes = text.split('').map(char => {
                const code = char.charCodeAt(0);
                return currentCandidate.sbox[code % 256]; 
            });

            const cipherHex = cipherBytes.map(b => b.toString(16).toUpperCase().padStart(2, '0')).join(' ');
            elOutputCipher.textContent = cipherHex;

            const decryptedChars = cipherBytes.map(byteVal => {
                const originalCode = inverseSBox[byteVal];
                return String.fromCharCode(originalCode);
            });

            elOutputDecrypted.textContent = decryptedChars.join('');
        }

        selector.addEventListener('change', (e) => updateUI(e.target.value));
        elInputPlain.addEventListener('input', doProcess);

        initDropdown();
        updateUI(selector.value);

    </script>
</body>
</html>
